name: Android App Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'EAS build profile'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - preview
        - production

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # ä¸ä½¿ç”¨ yarn ç¼“å­˜ï¼Œè®© corepack ç®¡ç†

      - name: ðŸ”§ Enable Corepack and Setup Yarn
        run: |
          # å¯ç”¨ Corepack
          corepack enable
          # è®¾ç½®æ­£ç¡®çš„ Yarn ç‰ˆæœ¬ï¼ˆä¸Ž package.json ä¸€è‡´ï¼‰
          yarn set version 4.9.1
          # éªŒè¯ç‰ˆæœ¬
          yarn --version
          # æ¸…ç†ç¼“å­˜
          yarn cache clean --all

      - name: ðŸ˜ Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: ðŸ“¦ Install dependencies
        run: |
          # éªŒè¯ Yarn ç‰ˆæœ¬
          yarn --version
          # å®‰è£…ä¾èµ–
          yarn install --frozen-lockfile

      - name: ðŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“‹ Generate database schema
        run: |
          npx drizzle-kit generate
          yarn run prebuild

      - name: ðŸ”§ Setup environment for EAS build
        run: |
          # åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
          if [ "${{ github.event.inputs.build_profile || 'development' }}" == "production" ]; then
            echo "ENVIRONMENT=production" >> .env
          else
            echo "ENVIRONMENT=development" >> .env
          fi

      - name: ðŸ—ï¸ Build Android App with EAS
        run: |
          eas build --platform android --profile ${{ github.event.inputs.build_profile || 'development' }} --non-interactive --clear-cache
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-app-${{ github.event.inputs.build_profile || 'development' }}
          path: |
            *.apk
            *.aab
          retention-days: 7

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ”§ Enable Corepack and Setup Yarn
        run: |
          corepack enable
          yarn set version 4.9.1
          yarn --version
          yarn cache clean --all

      - name: ðŸ“¦ Install dependencies
        run: |
          yarn --version
          yarn install --frozen-lockfile

      - name: ðŸ” Run linting
        run: |
          yarn lint
          yarn check

      - name: ðŸ§ª Run tests
        run: yarn test
        continue-on-error: true

      - name: ðŸŒ Check i18n
        run: |
          yarn check:i18n
          yarn sync:i18n

  # æž„å»ºçŠ¶æ€æ±‡æ€»
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-android, code-quality]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate build summary
        run: |
          echo "## ðŸ“± Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Android | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-android.result }}" == "success" ]; then
            echo "âœ… **Build completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "- Check the artifacts section below to download the APK/AAB" >> $GITHUB_STEP_SUMMARY
            echo "- Build profile: ${{ github.event.inputs.build_profile || 'development' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build failed!**" >> $GITHUB_STEP_SUMMARY
            echo "- Check the build logs for errors" >> $GITHUB_STEP_SUMMARY
          fi
